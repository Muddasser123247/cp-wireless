<!DOCTYPE html>
<html lang="en">

<head>
 <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17745159642"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17745159642');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Customer</title>

  <!-- Optional: Google Font similar to CP Wireless vibe -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* =====================
       Base + Theme
    ====================== */
    :root {
      --bg: #f3f4f6;
      --bg-soft: #f9fafb;
      --surface: #ffffff;
      --border: #e5e7eb;
      --border-strong: #d1d5db;
      --accent: #0ea5e9;
      /* blue accent */
      --accent-soft: #e0f2fe;
      --accent-deep: #0369a1;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
      --radius-lg: 1rem;
      --radius-md: 0.75rem;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #eff6ff 0, #f9fafb 35%, #f3f4f6 100%);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    main {
      padding: 0rem 1.25rem 3rem;
    }

    /* =====================
       Header + Home Button
    ====================== */

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      padding: 1.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    #header-container {
      flex: 1;
    }

    .home-button {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: linear-gradient(135deg, #ffffff, #f3f4f6);
      font-size: 0.875rem;
      color: var(--text-muted);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      transition: all 0.18s ease-out;
    }

    .home-button i {
      font-size: 0.9rem;
    }

    .home-button:hover {
      border-color: var(--accent);
      color: var(--accent-deep);
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.18);
    }

    /* =====================
       Form Container
    ====================== */

    .form-container {
      max-width: 1100px;
      margin: 0 auto;
      background: var(--surface);
      border-radius: 1.5rem;
      
      padding: 2.25rem 2.5rem 2.5rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .form-container h2 {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
      letter-spacing: -0.03em;
    }

    .form-container>p.subtitle {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    /* Sections + Cards layout */
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 1.75rem;
    }

    .card {
      flex: 1 1 320px;
      background: var(--bg-soft);
      border-radius: var(--radius-lg);
      padding: 1.3rem 1.4rem 1.5rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top left, rgba(14, 165, 233, 0.12), transparent 55%);
      opacity: 0.7;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    .card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-main);
    }

    .card h3::after {
      content: "";
      flex: 1;
      margin-left: 0.75rem;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(148, 163, 184, 0.4), transparent);
    }

    /* =====================
       Form Controls
    ====================== */

    .form-group {
      margin-bottom: 0.85rem;
    }

    .form-group label {
      display: block;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 0.55rem 0.75rem;
      font-size: 0.92rem;
      font-family: inherit;
      background: #ffffff;
      color: var(--text-main);
      transition: border-color 0.16s ease-out, box-shadow 0.16s ease-out, background 0.16s ease-out;
    }

    .form-group input[readonly] {
      background: #f3f4f6;
      color: #4b5563;
      font-weight: 500;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 90px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.4);
      background: #ffffff;
    }

    .form-group small {
      display: block;
      margin-top: 0.15rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Checkboxes layout */
    .form-group>div {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.35rem;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      accent-color: var(--accent);
      cursor: pointer;
    }

    /* =====================
       Previous Repairs Table
    ====================== */

    #previousRepairsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      background: #ffffff;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    #previousRepairsTable thead {
      background: #eff6ff;
    }

    #previousRepairsTable th,
    #previousRepairsTable td {
      padding: 0.55rem 0.65rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    #previousRepairsTable th {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.78rem;
    }

    #previousRepairsTable tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    #previousRepairsTable tbody tr:hover {
      background: #e0f2fe;
    }

    /* =====================
       Pending Repairs Table (NEW)
    ====================== */

    #pendingRepairsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      background: #ffffff;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    #pendingRepairsTable thead {
      background: #eff6ff;
    }

    #pendingRepairsTable th,
    #pendingRepairsTable td {
      padding: 0.55rem 0.65rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    #pendingRepairsTable th {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.78rem;
    }

    #pendingRepairsTable tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    #pendingRepairsTable tbody tr:hover {
      background: #e0f2fe;
    }

    #pendingRepairsTable select {
      font-size: 0.8rem;
      padding: 0.2rem 0.4rem;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: #f9fafb;
    }

    /* =====================
       Submit Button
    ====================== */

    .form-group button[type="submit"] {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.7rem;
      border-radius: var(--radius-pill);
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-deep));
      color: #ffffff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 16px 35px rgba(37, 99, 235, 0.35);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out, filter 0.16s ease-out;
      margin-top: 0.5rem;
    }

    .form-group button[type="submit"]:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 18px 40px rgba(30, 64, 175, 0.4);
    }

    .form-group button[type="submit"]:active {
      transform: translateY(0);
      box-shadow: 0 10px 24px rgba(30, 64, 175, 0.35);
    }

    /* =====================
       Toast
    ====================== */

    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      min-width: 240px;
      max-width: 320px;
      padding: 0.8rem 1rem;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.85rem;
      border-radius: var(--radius-md);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.45);
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      z-index: 60;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* =====================
       Footer
    ====================== */

    footer {
      max-width: 1100px;
      margin: 1.5rem auto 2rem;
      padding: 0 1.25rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* =====================
       Responsive
    ====================== */

    @media (max-width: 768px) {
      header {
        padding-inline: 1rem;
      }

      main {
        padding-top: 6.5rem;
        padding-inline: 1rem;
      }

      .form-container {
        padding: 1.5rem 1.3rem 1.8rem;
        border-radius: 1.1rem;
      }

      .card {
        border-radius: 0.9rem;
      }

      .form-section {
        margin-bottom: 1.3rem;
      }
    }

    @media (max-width: 480px) {
      .home-button {
        padding-inline: 0.8rem;
      }

      .form-container h2 {
        font-size: 1.35rem;
      }
    }

    
  </style>
</head>

<body>
  <header>
    <div id="header-container"></div>
    
  </header>

  <main>
    <div class="form-container">
      <h2>New Customer</h2>
      <form id="repairForm">
        <div class="form-section">
          <div class="card">
            <h3>Ticket Information</h3>
            <div class="form-group">
              <label for="datetime">Date & Time</label>
              <input type="text" id="datetime" name="datetime" readonly>
            </div>
            <div class="form-group">
              <label for="ticket_number">Ticket Number</label>
              <input type="text" id="ticket_number" name="ticket_number" readonly>
            </div>
            <div class="form-group">
              <label for="status">Status</label>
              <input type="text" id="status" name="status" value="Open" readonly>
            </div>
          </div>
          <div class="card">
            <h3>Customer Details</h3>
            <div class="form-group">
              <label for="customer_name">Customer Name</label>
              <input type="text" id="customer_name" name="customer_name" required>
            </div>
            <div class="form-group">
              <label for="phone_number">Phone Number</label>
              <input type="tel" id="phone_number" name="phone_number" required>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" name="email" required>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="card">
            <h3>Repair Details</h3>
            <div class="form-group">
              <label for="repair_type">Repair Type</label>
              <select id="repair_type" name="repair_type" required>
                <option value="Phone">Phone</option>
                <option value="Laptop">Laptop</option>
                <option value="Game Console">Game Console</option>
                <option value="ipad-tablet">ipad-tablet</option>
                <option value="Desktop">Desktop</option>
              </select>
            </div>
            <div class="form-group">
              <label for="model">Model</label>
              <input type="text" id="model" name="model" required>
            </div>
            <div class="form-group">
              <label for="description">Description</label>
              <textarea id="description" name="description" rows="4" required></textarea>
            </div>
          </div>
          <div class="card">
            <h3>Estimate</h3>
            <div class="form-group">
              <label for="Price">Price</label>
              <input type="text" id="Price" name="Price">
            </div>

            <div class="form-section">
              <h3>Previous Repairs</h3>
              <table id="previousRepairsTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Ticket Number</th>
                    <th>Model</th>
                    <th>Description</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Previous repairs will be populated here -->
                </tbody>
              </table>
            </div>

          </div>
        </div>

        <div class="form-section">
          <div class="card">
            <h3>Send Ticket</h3>
            <div class="form-group">
              <label>Send Ticket via:</label>
              <div>
                <input type="checkbox" id="sendEmail" name="sendEmail">
                <label for="sendEmail">Email</label>
              </div>
              <div>
                <input type="checkbox" id="sendSms" name="sendSms">
                <label for="sendSms">Send SMS</label>
              </div>
              <div>
                <input type="checkbox" id="sendPrint" name="sendPrint">
                <label for="sendPrint">Print</label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <button type="submit">Submit</button>
        </div>

        <!-- ‚úÖ NEW: Pending Repairs card below Send Ticket -->
        <div class="form-section">
          <div class="card">
            <h3>Pending Repairs</h3>
            <table id="pendingRepairsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ticket</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>Repair</th>
                  <th>Description</th>
                  <th>Price</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Pending repairs will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        
      </form>
      <p id="responseMessage"></p>
    </div>

    <div id="toast" class="toast"></div>
  </main>
  <footer id="footer-container"></footer>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxErte4e884Us0G1RJS-Vs1sK4KeiByu6_ZEVFmFbToCiEYmMvtl4RwUMeb_jBzMLgj/exec";

    // Auto-fill date on page load + load pending repairs
    document.addEventListener("DOMContentLoaded", () => {
      const dt = document.getElementById("datetime");
      if (dt) dt.value = new Date().toLocaleString();

      // Load pending repairs on initial load
      loadPendingRepairs();
    });

    // Auto lookup customer on typing (name or phone)
    document.getElementById("customer_name").addEventListener("input", e => {
      fetchCustomer(e.target.value);
    });
    document.getElementById("phone_number").addEventListener("input", e => {
      fetchCustomer(e.target.value);
    });

    // SUBMIT FORM
    document.getElementById("repairForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const payload = {
        mode: "save", // üîë tells Apps Script this is SAVE, not SEARCH
        datetime: document.getElementById("datetime").value,
        ticket_number: document.getElementById("ticket_number").value || null,
        status: document.getElementById("status").value,
        customer_name: document.getElementById("customer_name").value,
        phone_number: document.getElementById("phone_number").value,
        email: document.getElementById("email").value,
        repair_type: document.getElementById("repair_type").value,
        model: document.getElementById("model").value,
        description: document.getElementById("description").value,
        Price: document.getElementById("Price").value,
        sendEmail: document.getElementById("sendEmail").checked
      };

      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "SUCCESS") {
            // Show ticket number from server
            document.getElementById("ticket_number").value = data.ticket_number;
            showToast(`Ticket saved! #${data.ticket_number}`);

            // Refresh pending repairs list
            loadPendingRepairs();

            // ‚úÖ CLEAR FORM AFTER 1 SECOND
            setTimeout(() => {
              document.getElementById("repairForm").reset();
              const tbody = document.querySelector("#previousRepairsTable tbody");
              if (tbody) tbody.innerHTML = "";
              document.getElementById("datetime").value = new Date().toLocaleString();
            }, 1000);

          } else {
            showToast("Error: " + (data.message || "Unknown error"));
          }
        })
        .catch(err => {
          console.error(err);
          showToast("Error sending data: " + err);
        });
    });

    // Toast
    function showToast(message) {
      const toast = document.getElementById("toast");
      if (!toast) {
        alert(message);
        return;
      }
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // üîç FETCH EXISTING CUSTOMER DATA USING POST (no CORS issues)
    async function fetchCustomer(searchValue) {
      if (!searchValue || searchValue.length < 2) {
        console.log("Search ignored (too short):", searchValue);
        return;
      }

      console.log("Searching for:", searchValue);

      const payload = {
        mode: "search",   // tells Apps Script to use search mode
        query: searchValue
      };

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        let json;
        try {
          json = await res.json();
        } catch (err) {
          console.error("‚ùå Failed to parse JSON (backend returned invalid output):", err);
          console.log("RAW RESPONSE:", await res.text());
          return;
        }

        console.log("Search response:", json);

        if (json.status !== "SUCCESS") {
          console.warn("‚ùå Search failed:", json);
          return;
        }

        if (!json.results || json.results.length === 0) {
          console.log("‚Ñπ No matching customers found.");
          return;
        }

        const rows = json.results;
        const latest = rows[rows.length - 1]; // pick last entry

        // Columns from Sheet:
        // 0: serverTimestamp
        // 1: ticket_number
        // 2: status
        // 3: customer_name
        // 4: phone_number
        // 5: email
        // 6: repair_type
        // 7: model
        // 8: description
        // 9: Price

        // Auto-fill customer info
        document.getElementById("customer_name").value = latest[3] || "";
        document.getElementById("phone_number").value = latest[4] || "";
        document.getElementById("email").value = latest[5] || "";

        // Fill "Previous Repairs" table
        const tbody = document.querySelector("#previousRepairsTable tbody");
        if (!tbody) return;

        tbody.innerHTML = ""; // clear previous entries

        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${formatDate(r[0])}</td>
            <td>${r[1] || ""}</td>
            <td>${r[7] || ""}</td>
            <td>${r[8] || ""}</td>
            <td>$${r[9] || ""}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("‚ùå fetchCustomer() error:", err);
      }
    }

    // ‚úÖ NEW: Load Pending Repairs (status = Open)
    async function loadPendingRepairs() {
      const payload = {
        mode: "pending"
      };

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (json.status !== "SUCCESS" || !json.results) {
          console.warn("Pending repairs fetch failed:", json);
          return;
        }

        const tbody = document.querySelector("#pendingRepairsTable tbody");
        if (!tbody) return;

        tbody.innerHTML = "";

        const rows = json.results;
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const statusVal = r[2] || "Open";
          // apply color while building the row
        if (statusVal === "Open") tr.style.background = "#e0f2fe";           // blue
        if (statusVal === "Closed") tr.style.background = "#dcfce7";         // green
        if (statusVal === "Pending Parts") tr.style.background = "#fef3c7";  // orange

          tr.innerHTML = `
            <td>${formatDate(r[0])}</td>
            <td>${r[1] || ""}</td>
            <td>${r[3] || ""}</td>
            <td>${r[4] || ""}</td>
            <td>${r[6] || ""}</td>
            <td>$${r[9] || ""}</td>
            <td>${r[8] || ""}</td>
            <td>
                <select 
                    onchange="updateStatus('${r[1]}', this.value)"
                    style="background:${
                    statusVal === 'Closed' ? '#d1fae5' :
                    statusVal === 'Pending Parts' ? '#fde68a' :
                    '#bfdbfe'
                    };
                    color:#000; padding:4px; border-radius:6px;"
                >
                    <option value="Open" ${statusVal === 'Open' ? 'selected' : ''}>Open</option>
                    <option value="Closed" ${statusVal === 'Closed' ? 'selected' : ''}>Closed</option>
                    <option value="Pending Parts" ${statusVal === 'Pending Parts' ? 'selected' : ''}>Pending Parts</option>
                </select>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("Pending repairs error:", err);
      }
    }

    // ‚úÖ NEW: Update status in Sheet and refresh pending list
    /*async function updateStatus(ticketNumber, newStatus) {
      const payload = {
        mode: "updateStatus",
        ticket: ticketNumber,
        status: newStatus
      };

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.status === "SUCCESS") {
          showToast(`Status updated to ${newStatus}`);
          loadPendingRepairs(); // refresh list
        } else {
          showToast("Update failed: " + (data.message || "Unknown error"));
        }

      } catch (err) {
        console.error(err);
        showToast("Error updating status");
      }
    }*/

    function formatDate(isoString) {
  if (!isoString) return "";
  const d = new Date(isoString);
  return d.toLocaleString("en-US", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}


async function updateStatus(ticketNumber, newStatus) {
  const payload = {
    mode: "updateStatus",
    ticket_number: ticketNumber,
    status: newStatus
  };

  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if (json.status === "SUCCESS") {
      showToast(`Status updated to ${newStatus}`);
      loadPendingRepairs(); // refresh table
    } else {
      console.error("Update failed:", json);
      showToast("Error updating status");
    }

  } catch (err) {
    console.error("Status update error:", err);
    showToast("Network error updating status");
  }
}

  </script>

</body>

</html>


